<!--apps/home/templates/home/recording.html-->
{% extends "layouts/base.html" %}

{% block title %} Recordings {% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock stylesheets %}

{% block content %}

<div class="content">
  <div class="row">
    <div class="col-md-12">
      <div class="bg-dark p-4 rounded text-light">
        <div class="card bg-dark text-light mb-4">
          <div class="card-header border-bottom-0">
            <h5 class="title"><i class="bi bi-camera-reels-fill me-2"></i>Daftar Rekaman</h5>
            <div class="btn-group" role="group" aria-label="Tampilkan Pilihan">
              <button type="button" class="btn btn-primary active" id="show-videos-btn">Tampilkan Rekaman Video MP4</button>
              <button type="button" class="btn btn-secondary" id="show-screenshots-btn">Tampilkan Screenshot</button>
            </div>
          </div>
          <div class="card-body pt-0">
            <div class="table-responsive">
              <table class="table tablesorter table-hover">
                <thead class="text-primary">
                  <tr>
                    <th>Nama File</th>
                    <th>Ukuran</th>
                    <th class="text-center">Tindakan</th>
                  </tr>
                </thead>
                <tbody id="recording-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
            <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content bg-dark text-light">
            <div class="modal-header border-0">
              <h5 class="modal-title" id="videoModalLabel">Memutar Video</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <video id="videoPlayer" class="w-100" controls>
                Browser Anda tidak mendukung tag video.
              </video>
            </div>
          </div>
        </div>
      </div>

            <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content bg-dark text-light">
            <div class="modal-header border-0">
              <h5 class="modal-title" id="imageModalLabel">Melihat Screenshot</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="imageViewer" class="img-fluid" src="" alt="Screenshot">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
        var videoData = {{ recordings | tojson }};
        var screenshotData = {{ screenshots | tojson }};

        function renderTable(data, type) {
            var tableBody = $('#recording-table-body');
            tableBody.empty();

            if (data && data.length > 0) {
                $.each(data, function(index, file) {
                    var actionHtml = '';
                    if (type === 'video') {
                        actionHtml = `
                            <a href="#" class="btn btn-primary btn-sm play-video-btn"
                              data-bs-toggle="modal" data-bs-target="#videoModal"
                              data-video-url="/stream-recording/${file.name}?v=${Date.now()}" title="Putar Video">
                              <i class="bi bi-play-circle-fill"></i> Putar
                            </a>
                        `;
                    } else if (type === 'screenshot') {
                        actionHtml = `
                            <a href="#" class="btn btn-info btn-sm view-image-btn"
                              data-bs-toggle="modal" data-bs-target="#imageModal"
                              data-image-url="/stream-screenshot/${file.name}?v=${Date.now()}" title="Lihat Screenshot">
                              <i class="bi bi-image"></i> Lihat
                            </a>
                        `;
                    }
                    var newRow = `
                        <tr>
                          <td>${file.name}</td>
                          <td>${file.size}</td>
                          <td class="text-center">${actionHtml}</td>
                        </tr>
                    `;
                    tableBody.append(newRow);
                });
            } else {
                var message = (type === 'video') ? 'Tidak ada file rekaman .mp4 yang ditemukan.' : 'Tidak ada file screenshot yang ditemukan.';
                var alertHtml = `
                    <tr>
                      <td colspan="3" class="text-center">
                        <div class="alert alert-info" role="alert">${message}</div>
                      </td>
                    </tr>
                `;
                tableBody.append(alertHtml);
            }
        }

        renderTable(videoData, 'video');

        $('#show-videos-btn').click(function() {
            renderTable(videoData, 'video');
            $(this).removeClass('btn-secondary').addClass('btn-primary active');
            $('#show-screenshots-btn').removeClass('btn-primary active').addClass('btn-secondary');
        });

        $('#show-screenshots-btn').click(function() {
            renderTable(screenshotData, 'screenshot');
            $(this).removeClass('btn-secondary').addClass('btn-primary active');
            $('#show-videos-btn').removeClass('btn-primary active').addClass('btn-secondary');
        });

        $(document).on('click', '.play-video-btn', function(event) {
            var button = $(this);
            var videoUrl = button.data('video-url');
            var modalTitle = button.closest('tr').find('td:first').text();
            
            var modal = $('#videoModal');
            var videoPlayer = modal.find('#videoPlayer')[0];
            modal.find('.modal-title').text("Memutar: " + modalTitle);
            videoPlayer.src = videoUrl;
            videoPlayer.load();
            videoPlayer.play();
        });

        $('#videoModal').on('hidden.bs.modal', function () {
            var videoPlayer = $(this).find('#videoPlayer')[0];
            videoPlayer.pause();
            videoPlayer.src = "";
            videoPlayer.load();
        });

        $(document).on('click', '.view-image-btn', function(event) {
            var button = $(this);
            var imageUrl = button.data('image-url');
            var modalTitle = button.closest('tr').find('td:first').text();

            var modal = $('#imageModal');
            modal.find('.modal-title').text("Melihat: " + modalTitle);
            modal.find('#imageViewer').attr('src', imageUrl);
        });
    });
</script>
{% endblock javascripts %}