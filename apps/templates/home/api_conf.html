{% extends "layouts/base.html" %}
{% block title %}API Camera Configuration{% endblock %}

{% block content %}
<div class="content container">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">

            <div class="card shadow mb-5 bg-dark text-light">
                <div class="card-header border-bottom border-secondary">
                    <h4 class="title mb-0">üõ†Ô∏è Camera API Endpoint Configuration</h4>
                    <p class="category text-muted mb-0">Configure a new API endpoint for camera data retrieval or control (like Postman).</p>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('home_blueprint.cam_settings') }}" method="post">
                        
                        <div class="mb-3">
                            <label for="api-name" class="form-label">API Name</label>
                            <input type="text" class="form-control bg-secondary text-light border-dark" id="api-name" name="api-name"
                                   placeholder="e.g., Get Snapshot API" required>
                        </div>

                        <div class="mb-3">
                            <label for="api-url" class="form-label">API Endpoint URL</label>
                            <input type="url" class="form-control bg-secondary text-light border-dark" id="api-url" name="api-url"
                                   placeholder="e.g., http://192.168.1.100/api/camera/stream" required>
                        </div>
                          
                        <div class="mb-3">
                            <label for="http-method" class="form-label">HTTP Method</label>
                            <select class="form-select bg-secondary text-light border-dark" id="http-method" name="http-method" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="request-body" class="form-label">Request Body (JSON)</label>
                            <textarea class="form-control bg-secondary text-light border-dark" id="request-body" name="request-body" rows="5"
                                      placeholder='{"command": "get_snapshot", "quality": "high"}'></textarea>
                            <div class="form-text text-muted">Leave blank for GET/DELETE requests.</div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3 w-100">üíæ Submit API Endpoint</button>
                    </form>
                </div>
            </div>

            <div class="card shadow bg-dark text-light">
                <div class="card-header border-bottom border-secondary">
                    <h4 class="title mb-0">üì° Saved API Endpoints</h4>
                </div>
                <div class="card-body p-0">
                    {% if cameras %}
                        <ul class="list-group list-group-flush">
                            {% for cam in cameras %}
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-light border-secondary py-3">
                                    <div class="flex-grow-1 me-3">
                                        <strong class="text-info">{{ cam.name or "No Name" }} </strong> 
                                        <span class="badge bg-primary">{{ cam.http_method or 'N/A' }}</span>
                                        <br>
                                        <code class="text-warning small">{{ cam.api_url }}</code>
                                        <br>
                                        <small class="text-muted fst-italic">Body: {{ cam.request_body|truncate(50) or "None" }}</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#editModal{{ cam.id }}">
                                            Edit
                                        </button>

                                        <form action="{{ url_for('home_blueprint.delete_camera', cam_id=cam.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this endpoint?')" style="display:inline">
                                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                        </form>
                                    </div>
                                </li>

                                <div class="modal fade" id="editModal{{ cam.id }}" tabindex="-1" aria-labelledby="editModalLabel{{ cam.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content bg-dark text-light border-light">
                                            <div class="modal-header border-secondary">
                                                <h5 class="modal-title" id="editModalLabel{{ cam.id }}">Edit API Endpoint</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form method="POST" action="{{ url_for('home_blueprint.edit_camera', cam_id=cam.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="api-name-{{ cam.id }}" class="form-label">API Name</label>
                                                        <input type="text" class="form-control bg-secondary text-light border-dark" id="api-name-{{ cam.id }}" name="api-name" value="{{ cam.name or '' }}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="http-method-{{ cam.id }}" class="form-label">HTTP Method</label>
                                                        <select class="form-select bg-secondary text-light border-dark" id="http-method-{{ cam.id }}" name="http-method" required>
                                                            <option value="GET" {% if cam.http_method == 'GET' %}selected{% endif %}>GET</option>
                                                            <option value="POST" {% if cam.http_method == 'POST' %}selected{% endif %}>POST</option>
                                                            <option value="PUT" {% if cam.http_method == 'PUT' %}selected{% endif %}>PUT</option>
                                                            <option value="DELETE" {% if cam.http_method == 'DELETE' %}selected{% endif %}>DELETE</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="api-url-{{ cam.id }}" class="form-label">API Endpoint URL</label>
                                                        <input type="url" class="form-control bg-secondary text-light border-dark" id="api-url-{{ cam.id }}" name="api-url" value="{{ cam.api_url or '' }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="request-body-{{ cam.id }}" class="form-label">Request Body (JSON)</label>
                                                        <textarea class="form-control bg-secondary text-light border-dark" id="request-body-{{ cam.id }}" name="request-body" rows="5">{{ cam.request_body or '' }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer border-secondary">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Update Endpoint</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="p-4">
                            <p class="text-light mb-0">No API endpoints saved yet. Start by adding one above!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock content %}
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock javascripts %}